const resultDiv = document.getElementById("result");
const now = Date.now();

// 1) ロック中なら表示だけして終了（値を固定）
if (now < lockUntil && lockedLabel !== null) {
    resultDiv.innerHTML =
        `判定：<b>${lockedLabel}</b>（信頼度 ${(lockedConfidence * 100).toFixed(1)}%）［固定中］`;
    return;
}

// 2) しきい値未満は「不明」＋安定カウントをリセット
if (maxProbability < CONFIDENCE_THRESHOLD) {
    lockedLabel = null;
    stableCount = 0;
    lastLabel = null;
    resultDiv.innerHTML = "判定：不明（信頼度不足）";
    return;
}

// 3) 同じラベルが連続しているか数える（安定判定）
if (label === lastLabel) {
    stableCount += 1;
} else {
    lastLabel = label;
    stableCount = 1;
}

// 4) 連続回数が足りない間は「判定中」表示
resultDiv.innerHTML =
    `判定中：<b>${label}</b>（信頼度 ${(maxProbability * 100).toFixed(1)}%） ` +
    `安定度 ${stableCount}/${STABLE_REQUIRED}`;

if (stableCount >= STABLE_REQUIRED) {
    // 5) 確定 → ロック
    lockedLabel = label;
    lockedConfidence = maxProbability;
    lockUntil = now + LOCK_MS;

    resultDiv.innerHTML =
        `判定：<b>${lockedLabel}</b>（信頼度 ${(lockedConfidence * 100).toFixed(1)}%）［確定］`;
}

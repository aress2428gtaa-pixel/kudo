<div>Teachable Machine Image Model</div>
<button type="button" onclick="init()">Start</button>

<div id="webcam-container"></div>
<div id="result"></div>
<div id="label-container"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/4BqvTJVgw/";

    let model, webcam, labelContainer, maxPredictions;

    // ===== 追加設定 =====
    const CONFIDENCE_THRESHOLD = 0.6;   // 信頼度しきい値（60%）
    const SMOOTHING_FRAMES = 5;          // 安定化フレーム数
    let predictionHistory = [];
    // ===================

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(200, 200, true);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        document.getElementById("webcam-container").appendChild(webcam.canvas);

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);

        // --- 生の確率表示 ---
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.childNodes[i].innerHTML =
                `${prediction[i].className}: ${prediction[i].probability.toFixed(2)}`;
        }

        // --- 安定化用に履歴へ追加 ---
        predictionHistory.push(prediction.map(p => p.probability));
        if (predictionHistory.length > SMOOTHING_FRAMES) {
            predictionHistory.shift();
        }

        // --- 平均確率を計算 ---
        let avgProbabilities = new Array(maxPredictions).fill(0);
        for (let frame of predictionHistory) {
            frame.forEach((p, i) => avgProbabilities[i] += p);
        }
        avgProbabilities = avgProbabilities.map(p => p / predictionHistory.length);

        // --- 最大確率クラスを取得 ---
        let maxIndex = avgProbabilities.indexOf(Math.max(...avgProbabilities));
        let maxProbability = avgProbabilities[maxIndex];
        let label = model.getClassLabels()[maxIndex];

        // --- しきい値判定 ---
        const resultDiv = document.getElementById("result");
        if (maxProbability < CONFIDENCE_THRESHOLD) {
            resultDiv.innerHTML = "判定：不明（信頼度不足）";
        } else {
            resultDiv.innerHTML =
                `判定：<b>${label}</b>（信頼度 ${(maxProbability * 100).toFixed(1)}%）`;
        }
    }
</script>

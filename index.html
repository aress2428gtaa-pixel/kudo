<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Teachable Machine Image Model</title>
</head>

<body>
    <div><b>Teachable Machine Image Model</b></div>
    <button type="button" onclick="init()">Start</button>

    <div id="webcam-container"></div>
    <div id="result" style="font-size:22px; font-weight:bold; margin:10px 0;"></div>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // ===== モデルURL =====
        const URL = "https://teachablemachine.withgoogle.com/models/4BqvTJVgw/";

        let model, webcam, labelContainer, maxPredictions;

        // ===== 設定 =====
        const CONFIDENCE_THRESHOLD = 0.6; // 信頼度しきい値
        const SMOOTHING_FRAMES = 15;      // 平均化フレーム数
        const STABLE_REQUIRED = 8;        // 連続一致回数
        const LOCK_MS = 1500;             // 確定後の固定時間(ms)

        // ===== 状態管理 =====
        let predictionHistory = [];
        let lastLabel = null;
        let stableCount = 0;

        let lockedLabel = null;
        let lockedConfidence = 0;
        let lockUntil = 0;

        // ===== 初期化 =====
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            webcam = new tmImage.Webcam(200, 200, true);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);

            labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = "";
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        // ===== 予測処理 =====
        async function predict() {
            const prediction = await model.predict(webcam.canvas);

            // --- 生の確率表示 ---
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.childNodes[i].innerHTML =
                    `${prediction[i].className}: ${prediction[i].probability.toFixed(2)}`;
            }

            // --- 履歴に追加 ---
            predictionHistory.push(prediction.map(p => p.probability));
            if (predictionHistory.length > SMOOTHING_FRAMES) {
                predictionHistory.shift();
            }

            // --- 平均確率計算 ---
            let avgProbabilities = new Array(maxPredictions).fill(0);
            for (let frame of predictionHistory) {
                frame.forEach((p, i) => avgProbabilities[i] += p);
            }
            avgProbabilities = avgProbabilities.map(p => p / predictionHistory.length);

            // --- 最大クラス ---
            let maxIndex = avgProbabilities.indexOf(Math.max(...avgProbabilities));
            let maxProbability = avgProbabilities[maxIndex];
            let label = model.getClassLabels()[maxIndex];

            const resultDiv = document.getElementById("result");
            const now = Date.now();

            // ===== ロック中 =====
            if (now < lockUntil && lockedLabel !== null) {
                resultDiv.innerHTML =
                    `判定：<b>${lockedLabel}</b>（信頼度 ${(lockedConfidence * 100).toFixed(1)}%）［固定中］`;
                return;
            }

            // ===== しきい値未満 =====
            if (maxProbability < CONFIDENCE_THRESHOLD) {
                lockedLabel = null;
                stableCount = 0;
                lastLabel = null;
                resultDiv.innerHTML = "判定：不明（信頼度不足）";
                return;
            }

            // ===== 安定判定 =====
            if (label === lastLabel) {
                stableCount += 1;
            } else {
                lastLabel = label;
                stableCount = 1;
            }

            resultDiv.innerHTML =
                `判定中：<b>${label}</b>（信頼度 ${(maxProbability * 100).toFixed(1)}%） ` +
                `安定度 ${stableCount}/${STABLE_REQUIRED}`;

            // ===== 確定 =====
            if (stableCount >= STABLE_REQUIRED) {
                lockedLabel = label;
                lockedConfidence = maxProbability;
                lockUntil = now + LOCK_MS;

                resultDiv.innerHTML =
                    `判定：<b>${lockedLabel}</b>（信頼度 ${(lockedConfidence * 100).toFixed(1)}%）［確定］`;
            }
        }
    </script>
</body>
</html>
